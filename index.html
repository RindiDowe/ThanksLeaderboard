<script>
  // üîß Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdgAgCChuiHXKx3N9Re1z5bGYoVz_iZAE",
    authDomain: "cestypingchallenge.firebaseapp.com",
    projectId: "cestypingchallenge",
    storageBucket: "cestypingchallenge.firebasestorage.app",
    messagingSenderId: "1085002897356",
    appId: "1:1085002897356:web:318e8e0162224a96f4af69",
    measurementId: "G-40647JYDD0"
    // IMPORTANT:
    // Add this to make Firebase DB work:
    // databaseURL: "https://cestypingchallenge-default-rtdb.firebaseio.com"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const scoresRef = db.ref("thanksgivingTypingScores2025");

  // DOM elements
  const playerNameInput = document.getElementById("playerName");
  const lockNameBtn = document.getElementById("lockNameBtn");
  const playerStatus = document.getElementById("playerStatus");

  const targetTextEl = document.getElementById("targetText");
  const typingInput = document.getElementById("typingInput");
  const startRoundBtn = document.getElementById("startRoundBtn");
  const submitBtn = document.getElementById("submitBtn");

  const timerDisplay = document.getElementById("timerDisplay");
  const wpmStat = document.getElementById("wpmStat");
  const accuracyStat = document.getElementById("accuracyStat");
  const resultMessage = document.getElementById("resultMessage");
  const leaderboardList = document.getElementById("leaderboardList");

  let currentPlayerName = "";
  let currentSentence = "";
  let roundActive = false;
  let startTime = null;
  let timerInterval = null;

  // Thanksgiving paragraphs
  const sentences = [
    "On Thanksgiving morning, our house smells like turkey and spices. The kitchen counters are covered with pie crusts, cranberries, and fresh rolls. Everyone helps a little, even if it just means taste-testing the food.",
    "We set the table with our nicest plates and colorful napkins. A big bowl of mashed potatoes sits next to the gravy boat. In the center, a small pumpkin holds a candle that flickers softly.",
    "Before we eat, each person shares something they are thankful for this year. Some people talk about family and friends, and others mention school and teachers. By the end, the room feels warm with gratitude.",
    "After dinner, our family likes to go for a walk in the chilly autumn air. The leaves crunch under our shoes, and our breath makes tiny white clouds. We talk, laugh, and point out the brightest stars in the sky.",
    "My favorite part of Thanksgiving is dessert time. There are slices of pumpkin pie, apple pie, and sometimes even chocolate cake. We add whipped cream on top and pretend we are food judges on a cooking show.",
    "Our cousins drive for hours just to spend Thanksgiving with us. When they arrive, everyone shouts and runs to the door. The house suddenly feels louder, sillier, and much more fun.",
    "After we eat, some people watch football while others play board games. The living room fills with cheers, groans, and bursts of laughter. Even the dog curls up nearby, hoping for dropped snacks.",
    "On the day after Thanksgiving, we like to make turkey sandwiches with the leftovers. We stack turkey, lettuce, and cranberry sauce on fresh bread. Somehow, the leftovers taste just as good as the feast."
  ];

  function pickRandomSentence() {
    return sentences[Math.floor(Math.random() * sentences.length)];
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    timerDisplay.textContent = "0.0 s";
  }

  function startTimer() {
    startTime = performance.now();
    resetTimer();
    timerInterval = setInterval(() => {
      if (!startTime) return;
      const elapsed = (performance.now() - startTime) / 1000;
      timerDisplay.textContent = elapsed.toFixed(1) + " s";
    }, 100);
  }

  function stopTimer() {
    const elapsed = performance.now() - startTime;
    startTime = null;
    clearInterval(timerInterval);
    timerInterval = null;
    return elapsed;
  }

  function calculateAccuracy(target, actual) {
    const maxLen = Math.max(target.length, actual.length);
    let correct = 0;

    for (let i = 0; i < maxLen; i++) {
      if (target[i] === actual[i]) correct++;
    }

    return (correct / maxLen) * 100;
  }

  function celebrate() {
    const pieces = 40;
    for (let i = 0; i < pieces; i++) {
      const div = document.createElement("div");
      div.className = "confetti-piece";
      div.style.left = Math.random() * 100 + "vw";
      div.style.backgroundColor = ["#f97316", "#facc15", "#22c55e", "#ec4899"][Math.floor(Math.random() * 4)];
      div.style.animationDelay = Math.random() * 0.3 + "s";
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 1600);
    }

    resultMessage.classList.remove("bad");
    resultMessage.classList.add("good");
    resultMessage.textContent = "Gobble gobble! Great round!";
  }

  function saveScore(name, wpm, accuracy) {
    scoresRef.push({
      name,
      wpm,
      accuracy,
      createdAt: Date.now()
    });
  }

  function renderLeaderboard(snapshot) {
    const data = snapshot.val() || {};
    const rows = Object.values(data);

    rows.sort((a, b) => {
      if (b.wpm !== a.wpm) return b.wpm - a.wpm;
      if (b.accuracy !== a.accuracy) return b.accuracy - a.accuracy;
      return b.createdAt - a.createdAt;
    });

    const topTen = rows.slice(0, 10);
    leaderboardList.innerHTML = "";

    if (topTen.length === 0) {
      leaderboardList.innerHTML =
        `<li><span class="place">‚Äì</span><span class="name">No scores yet</span><span class="score">Be the first turkey!</span></li>`;
      return;
    }

    topTen.forEach((row, index) => {
      leaderboardList.innerHTML += `
        <li>
          <span class="place">${index + 1}.</span>
          <span class="name">${row.name}</span>
          <span class="score">${row.wpm} WPM ‚Ä¢ ${row.accuracy}%</span>
        </li>
      `;
    });
  }

  scoresRef.on("value", renderLeaderboard);

  // Lock name
  lockNameBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    if (!name) {
      playerStatus.textContent = "Please enter a name before locking in.";
      return;
    }
    currentPlayerName = name;
    playerNameInput.disabled = true;
    lockNameBtn.disabled = true;
    startRoundBtn.disabled = false;
    playerStatus.textContent = `You are locked in as ${currentPlayerName}. Good luck, turkey!`;
  });

  // Start round
  startRoundBtn.addEventListener("click", () => {
    if (!currentPlayerName) return;

    currentSentence = pickRandomSentence();
    targetTextEl.textContent = currentSentence;

    typingInput.disabled = false;
    typingInput.value = "";
    typingInput.focus();

    wpmStat.textContent = "0";
    accuracyStat.textContent = "0%";
    resultMessage.textContent =
      "Type the text as shown. You need at least 95% accuracy for the round to count.";
    resultMessage.classList.remove("good", "bad");

    roundActive = true;
    submitBtn.disabled = false;
    startRoundBtn.disabled = true;

    resetTimer();
    startTimer();
  });

  // Submit round ‚Äî requires ‚â• 95% accuracy
  submitBtn.addEventListener("click", () => {
    if (!roundActive) return;

    const typed = typingInput.value;

    if (!typed.trim()) {
      resultMessage.textContent = "You must type the full text before submitting.";
      resultMessage.classList.add("bad");
      wpmStat.textContent = "0";
      accuracyStat.textContent = "0%";
      return;
    }

    const accuracy = calculateAccuracy(currentSentence, typed);
    const accuracyRounded = Math.round(accuracy);

    accuracyStat.textContent = accuracyRounded + "%";

    // ‚ùå Too many mistakes ‚Äî keep typing, timer runs!
    if (accuracyRounded < 95) {
      resultMessage.classList.add("bad");
      resultMessage.textContent =
        `Accuracy ${accuracyRounded}%. You need at least 95% accuracy. Fix errors and try again.`;
      return;
    }

    // ‚úÖ Good enough ‚Äî count it!
    const elapsedMs = stopTimer();
    let minutes = elapsedMs / 60000;
    if (minutes < 0.05) minutes = 0.05;

    const wpm = Math.round((typed.length / 5) / minutes);
    wpmStat.textContent = wpm;

    celebrate();
    saveScore(currentPlayerName, wpm, accuracyRounded);

    typingInput.disabled = true;
    submitBtn.disabled = true;
    startRoundBtn.disabled = false;
    roundActive = false;
  });

  // Ctrl+Enter or Cmd+Enter submits
  typingInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      if (!submitBtn.disabled) submitBtn.click();
    }
  });

  // No pasting allowed
  typingInput.addEventListener("paste", (e) => {
    e.preventDefault();
    resultMessage.classList.add("bad");
    resultMessage.textContent = "No pasting ‚Äî you must type it yourself.";
  });
</script>
